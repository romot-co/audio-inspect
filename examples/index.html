<!doctype html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Audio Inspect Studio</title>
  <link rel="stylesheet" href="./studio.css">
</head>
<body>
  <main class="app">
    <header class="topbar">
      <h1>Audio Inspect Studio</h1>
      <p>Realtime + Offline Audio Monitoring</p>
    </header>

    <section class="layout">
      <aside class="panel controls">
        <h2>Source</h2>
        <div class="mode-switch" role="tablist" aria-label="Source mode">
          <button id="modeMicBtn" type="button" class="mode-btn active" data-mode="mic" role="tab" aria-selected="true">Microphone</button>
          <button id="modeFileBtn" type="button" class="mode-btn" data-mode="file" role="tab" aria-selected="false">File</button>
        </div>

        <section id="micPanel" class="subpanel">
          <div class="button-row">
            <button id="startMicBtn" type="button" class="btn-primary">Start Mic</button>
            <button id="stopMicBtn" type="button" class="btn-secondary" disabled>Stop Mic</button>
          </div>
        </section>

        <section id="filePanel" class="subpanel hidden">
          <label class="field">
            <span>Audio File (wav/mp3)</span>
            <input id="fileInput" type="file" accept=".wav,audio/wav,audio/x-wav,.mp3,audio/mpeg">
          </label>
          <audio id="filePlayer" controls preload="metadata"></audio>
          <dl class="meta">
            <div><dt>File</dt><dd id="fileMetaName">-</dd></div>
            <div><dt>Duration</dt><dd id="fileMetaDuration">-</dd></div>
            <div><dt>Sample Rate</dt><dd id="fileMetaRate">-</dd></div>
            <div><dt>Channels</dt><dd id="fileMetaChannels">-</dd></div>
          </dl>
        </section>

        <h2>Realtime Tuning</h2>
        <div class="form-grid">
          <label class="field">
            <span>FFT Size</span>
            <select id="fftSize">
              <option value="1024">1024</option>
              <option value="2048" selected>2048</option>
              <option value="4096">4096</option>
              <option value="8192">8192</option>
            </select>
          </label>
          <label class="field">
            <span>Frequency Scale</span>
            <select id="frequencyScale">
              <option value="log" selected>Log</option>
              <option value="linear">Linear</option>
            </select>
          </label>
          <label class="field">
            <span>Display Max Hz</span>
            <input id="displayMaxHz" type="number" value="12000" step="100">
          </label>
          <label class="field">
            <span>Smoothing</span>
            <div class="range-row">
              <input id="smoothing" type="range" min="0" max="0.98" step="0.01" value="0.82">
              <output id="smoothingValue">0.82</output>
            </div>
          </label>
          <label class="field">
            <span>Min dB</span>
            <input id="minDb" type="number" value="-100" step="1">
          </label>
          <label class="field">
            <span>Max dB</span>
            <input id="maxDb" type="number" value="-16" step="1">
          </label>
        </div>

        <div class="button-row">
          <button id="captureBtn" type="button" class="btn-secondary">Capture Snapshot</button>
          <button id="resetStatsBtn" type="button" class="btn-secondary">Reset Stats</button>
        </div>

        <h2>Offline Analysis</h2>
        <div class="checks" id="offlineChecks">
          <label><input type="checkbox" data-offline-analysis="rms" checked> RMS / Peak / Crest</label>
          <label><input type="checkbox" data-offline-analysis="spectrum" checked> Spectrum</label>
          <label><input type="checkbox" data-offline-analysis="spectral" checked> Spectral Features</label>
          <label><input type="checkbox" data-offline-analysis="lufs" checked> LUFS</label>
          <label><input type="checkbox" data-offline-analysis="vad" checked> VAD</label>
          <label><input type="checkbox" data-offline-analysis="mfcc"> MFCC</label>
        </div>
        <label class="toggle-line">
          <input id="offlineNormalize" type="checkbox" checked>
          Normalize before offline analysis
        </label>
        <button id="runOfflineBtn" type="button" class="btn-primary" disabled>Run Full File Analysis</button>
        <p id="offlineStatus" class="status-line">ファイルを選択するとオフライン解析を実行できます。</p>
      </aside>

      <section class="panel main">
        <div class="main-head">
          <h2>Realtime Analyzer</h2>
          <span id="liveStatusBadge" class="badge">Idle</span>
        </div>

        <div class="metric-grid">
          <article><h3>Source</h3><p id="metricSource">-</p></article>
          <article><h3>RMS</h3><p id="metricRms">-</p></article>
          <article><h3>Peak</h3><p id="metricPeak">-</p></article>
          <article><h3>Dominant</h3><p id="metricDominant">-</p></article>
          <article><h3>Centroid</h3><p id="metricCentroid">-</p></article>
          <article><h3>ZCR</h3><p id="metricZcr">-</p></article>
          <article><h3>Pitch</h3><p id="metricPitch">-</p></article>
          <article><h3>Note</h3><p id="metricNote">-</p></article>
          <article><h3>Speech Ratio</h3><p id="metricSpeechRatio">-</p></article>
          <article><h3>Momentary LUFS</h3><p id="metricMomentary">-</p></article>
          <article><h3>Short-term LUFS</h3><p id="metricShortTerm">-</p></article>
          <article><h3>Integrated LUFS</h3><p id="metricIntegrated">-</p></article>
          <article><h3>Est True Peak</h3><p id="metricTruePeak">-</p></article>
          <article><h3>Headroom</h3><p id="metricHeadroom">-</p></article>
          <article><h3>Clip Count</h3><p id="metricClipCount">-</p></article>
          <article><h3>Correlation</h3><p id="metricCorrelation">-</p></article>
          <article><h3>Stereo Width</h3><p id="metricStereoWidth">-</p></article>
          <article><h3>Balance</h3><p id="metricStereoBalance">-</p></article>
        </div>

        <section class="band-section">
          <h3>Band Meters</h3>
          <div class="band-row"><span>Sub</span><div class="meter"><div id="band_sub_fill"></div></div><b id="band_sub_val">-</b></div>
          <div class="band-row"><span>Bass</span><div class="meter"><div id="band_bass_fill"></div></div><b id="band_bass_val">-</b></div>
          <div class="band-row"><span>LowMid</span><div class="meter"><div id="band_lowmid_fill"></div></div><b id="band_lowmid_val">-</b></div>
          <div class="band-row"><span>HighMid</span><div class="meter"><div id="band_highmid_fill"></div></div><b id="band_highmid_val">-</b></div>
          <div class="band-row"><span>Air</span><div class="meter"><div id="band_air_fill"></div></div><b id="band_air_val">-</b></div>
        </section>

        <section class="canvas-grid">
          <article class="canvas-card">
            <div class="canvas-head"><h3>Spectrum</h3><span>Realtime</span></div>
            <canvas id="spectrumCanvas" width="1200" height="420"></canvas>
          </article>
          <article class="canvas-card">
            <div class="canvas-head"><h3>Waterfall Spectrogram</h3><span>Realtime</span></div>
            <canvas id="waterfallCanvas" width="1200" height="380"></canvas>
          </article>
          <article class="canvas-card">
            <div class="canvas-head"><h3>Waveform</h3><span>Realtime</span></div>
            <canvas id="waveformCanvas" width="1200" height="260"></canvas>
          </article>
          <article class="canvas-card">
            <div class="canvas-head"><h3>Stereo Scope</h3><span>Vectorscope (L-R / L+R)</span></div>
            <canvas id="stereoCanvas" width="1200" height="260"></canvas>
          </article>
          <article class="canvas-card">
            <div class="canvas-head"><h3>VAD Timeline</h3><span>Speech / Silence</span></div>
            <canvas id="vadCanvas" width="1200" height="160"></canvas>
          </article>
          <article class="canvas-card">
            <div class="canvas-head"><h3>MFCC Heatmap</h3><span>13 Coefficients</span></div>
            <canvas id="mfccCanvas" width="1200" height="220"></canvas>
          </article>
        </section>
      </section>

      <aside class="panel side">
        <h2>Snapshots</h2>
        <ul id="snapshotList" class="snapshot-list">
          <li class="empty">Capture Snapshot で履歴を残せます。</li>
        </ul>

        <h2>Offline Results</h2>
        <div id="offlineResults" class="result-stack">
          <p class="empty">オフライン解析結果はここに表示されます。</p>
        </div>

        <details>
          <summary>Raw JSON</summary>
          <pre id="rawJson">{}</pre>
        </details>
      </aside>
    </section>
  </main>

  <script type="module" src="./studio.js"></script>
</body>
</html>
